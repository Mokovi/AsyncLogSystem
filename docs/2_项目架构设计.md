# 项目架构设计

## 1. 系统整体架构

### 1.1 架构概览
```
┌─────────────────────────────────────────────────────────────┐
│                    业务应用层 (Business Layer)                │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    日志接口层 (Log Interface Layer)          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   DEBUG    │  │    INFO     │  │       ERROR         │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    日志管理层 (Log Management Layer)         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                LogManager (Singleton)                  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│  │  │   Config   │  │   Queue     │  │  Dispatcher │   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    队列管理层 (Queue Management Layer)       │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              LockFreeQueue<LogMessage>                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│  │  │  Producer   │  │   Buffer    │  │  Consumer   │   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    输出策略层 (Output Strategy Layer)        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │FileOutput  │  │ConsoleOutput│  │   NetworkOutput     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    装饰器层 (Decorator Layer)                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ Timestamp  │  │   Color     │  │    Compression     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    系统资源层 (System Resource Layer)        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   File     │  │   Console   │  │       Network       │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心组件
- **LogManager**: 日志管理器，单例模式
- **LockFreeQueue**: 无锁队列，生产者-消费者模式
- **ILogOutput**: 日志输出接口，策略模式
- **LogDecorator**: 日志装饰器，装饰器模式
- **LogOutputFactory**: 日志输出工厂，工厂模式

## 2. 模块详细设计

### 2.1 日志管理器模块 (LogManager)

#### 2.1.1 职责
- 管理日志配置
- 协调各个组件
- 提供统一的日志接口
- 管理生命周期

#### 2.1.2 类设计
```cpp
class LogManager {
private:
    // 单例相关
    static std::unique_ptr<LogManager> instance;
    static std::mutex instanceMutex;
    
    // 核心组件
    std::unique_ptr<Config> config;
    std::unique_ptr<LockFreeQueue<LogMessage>> messageQueue;
    std::unique_ptr<LogDispatcher> dispatcher;
    std::vector<std::unique_ptr<ILogOutput>> outputs;
    
    // 工作线程
    std::thread workerThread;
    std::atomic<bool> running;
    
public:
    // 单例访问
    static LogManager& getInstance();
    
    // 配置管理
    void setConfig(const Config& config);
    const Config& getConfig() const;
    
    // 输出管理
    void addOutput(std::unique_ptr<ILogOutput> output);
    void removeOutput(size_t index);
    void clearOutputs();
    
    // 日志记录
    void log(LogLevel level, const std::string& message);
    void log(LogLevel level, const std::string& message, 
             const std::string& file, int line);
    
    // 生命周期管理
    void start();
    void stop();
    void flush();
    
private:
    LogManager();
    ~LogManager();
    void workerFunction();
    void processMessage(const LogMessage& msg);
};
```

### 2.2 队列管理模块 (LockFreeQueue)

#### 2.2.1 职责
- 存储待处理的日志消息
- 支持多生产者多消费者
- 提供线程安全的操作接口

#### 2.2.2 类设计
```cpp
template<typename T>
class LockFreeQueue {
private:
    struct Node {
        T data;
        std::atomic<Node*> next;
        Node(const T& item) : data(item), next(nullptr) {}
    };
    
    std::atomic<Node*> head;
    std::atomic<Node*> tail;
    std::atomic<size_t> size;
    
public:
    LockFreeQueue();
    ~LockFreeQueue();
    
    // 基本操作
    void push(const T& item);
    bool pop(T& item);
    bool empty() const;
    size_t getSize() const;
    
    // 批量操作
    void pushBatch(const std::vector<T>& items);
    size_t popBatch(std::vector<T>& items, size_t maxCount);
    
private:
    void cleanup();
};
```

### 2.3 日志输出模块 (ILogOutput)

#### 2.3.1 职责
- 定义日志输出接口
- 实现具体的输出策略
- 支持装饰器模式

#### 2.3.2 类设计
```cpp
// 基础接口
class ILogOutput {
public:
    virtual ~ILogOutput() = default;
    virtual void write(const LogMessage& msg) = 0;
    virtual void flush() = 0;
    virtual void close() = 0;
};

// 文件输出
class FileOutput : public ILogOutput {
private:
    std::string filePath;
    std::ofstream fileStream;
    std::mutex fileMutex;
    
public:
    explicit FileOutput(const std::string& path);
    ~FileOutput() override;
    
    void write(const LogMessage& msg) override;
    void flush() override;
    void close() override;
    
private:
    void rotateFile();
    void openFile();
};

// 控制台输出
class ConsoleOutput : public ILogOutput {
public:
    void write(const LogMessage& msg) override;
    void flush() override;
    void close() override;
};

// 网络输出
class NetworkOutput : public ILogOutput {
private:
    std::string host;
    int port;
    std::unique_ptr<NetworkConnection> connection;
    
public:
    NetworkOutput(const std::string& host, int port);
    void write(const LogMessage& msg) override;
    void flush() override;
    void close() override;
};
```

### 2.4 装饰器模块 (LogDecorator)

#### 2.4.1 职责
- 增强日志内容
- 支持功能组合
- 保持接口一致性

#### 2.4.2 类设计
```cpp
// 基础装饰器
class LogDecorator : public ILogOutput {
protected:
    std::unique_ptr<ILogOutput> wrapped;
    
public:
    explicit LogDecorator(std::unique_ptr<ILogOutput> output);
    void write(const LogMessage& msg) override;
    void flush() override;
    void close() override;
};

// 时间戳装饰器
class TimestampDecorator : public LogDecorator {
private:
    std::string format;
    
public:
    TimestampDecorator(std::unique_ptr<ILogOutput> output, 
                      const std::string& timeFormat = "%Y-%m-%d %H:%M:%S");
    void write(const LogMessage& msg) override;
    
private:
    std::string getCurrentTimestamp();
};

// 颜色装饰器
class ColorDecorator : public LogDecorator {
public:
    explicit ColorDecorator(std::unique_ptr<ILogOutput> output);
    void write(const LogMessage& msg) override;
    
private:
    std::string getColorCode(LogLevel level);
};

// 压缩装饰器
class CompressionDecorator : public LogDecorator {
public:
    explicit CompressionDecorator(std::unique_ptr<ILogOutput> output);
    void write(const LogMessage& msg) override;
    
private:
    std::string compress(const std::string& data);
};
```

### 2.5 工厂模块 (LogOutputFactory)

#### 2.5.1 职责
- 根据配置创建日志输出对象
- 管理输出对象的生命周期
- 支持插件式扩展

#### 2.5.2 类设计
```cpp
class LogOutputFactory {
public:
    // 创建输出对象
    static std::unique_ptr<ILogOutput> createOutput(
        const std::string& type, 
        const Config& config
    );
    
    // 注册自定义输出类型
    static void registerOutputType(
        const std::string& type,
        std::function<std::unique_ptr<ILogOutput>(const Config&)> creator
    );
    
private:
    static std::unordered_map<std::string, 
        std::function<std::unique_ptr<ILogOutput>(const Config&)>> creators;
    
    // 内置输出类型
    static std::unique_ptr<ILogOutput> createFileOutput(const Config& config);
    static std::unique_ptr<ILogOutput> createConsoleOutput(const Config& config);
    static std::unique_ptr<ILogOutput> createNetworkOutput(const Config& config);
};
```

## 3. 数据流设计

### 3.1 日志记录流程
```
业务线程 → LogManager::log() → 消息入队 → 工作线程处理 → 分发器 → 输出目标
```

### 3.2 消息处理流程
```
1. 接收日志消息
2. 格式化消息内容
3. 应用装饰器处理
4. 分发到各个输出目标
5. 执行输出操作
6. 错误处理和重试
```

### 3.3 配置更新流程
```
配置文件变更 → 配置解析器 → 配置验证 → 动态更新 → 组件重新配置
```

## 4. 线程模型

### 4.1 线程划分
- **主线程**: 业务逻辑执行
- **工作线程**: 日志消息处理
- **I/O线程**: 文件/网络操作（可选）

### 4.2 线程安全策略
- **无锁队列**: 消息传递
- **读写锁**: 配置访问
- **互斥锁**: 输出操作
- **原子操作**: 状态标志

## 5. 错误处理策略

### 5.1 异常处理
- 异常安全的设计
- 错误恢复机制
- 降级策略

### 5.2 错误分类
- **配置错误**: 配置无效或缺失
- **I/O错误**: 文件/网络操作失败
- **内存错误**: 内存分配失败
- **系统错误**: 系统资源不足

## 6. 性能设计

### 6.1 性能指标
- **吞吐量**: 每秒处理的日志条数
- **延迟**: 从记录到输出的时间
- **内存使用**: 内存占用和分配效率
- **CPU使用**: CPU占用率

### 6.2 优化策略
- **批量处理**: 减少系统调用
- **内存池**: 减少内存分配
- **异步I/O**: 提高I/O效率
- **缓存优化**: 减少重复计算
