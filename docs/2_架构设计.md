# AsyncLogSystem 项目架构设计

## 1. 系统整体架构

### 1.1 架构概览
```
┌─────────────────────────────────────────────────────────────┐
│                    业务应用层 (Business Layer)                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                应用程序业务逻辑                          │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │   业务模块A │  │   业务模块B │  │    业务模块C    │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    日志接口层 (Log Interface Layer)          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                统一日志接口                              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │   DEBUG    │  │    INFO     │  │      ERROR      │ │ │
│  │  │   WARN     │  │    FATAL    │  │   自定义级别    │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    日志管理层 (Log Management Layer)         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                LogManager (Singleton)                  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│  │  │   Config   │  │   Queue     │  │  Dispatcher │   │ │
│  │  │  管理      │  │   管理      │  │    管理     │   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    队列管理层 (Queue Management Layer)       │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              LockFreeQueue<LogMessage>                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│  │  │  Producer   │  │   Buffer    │  │  Consumer   │   │ │
│  │  │  生产者     │  │   缓冲区    │  │   消费者    │   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    输出策略层 (Output Strategy Layer)        │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                输出策略接口                              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │FileOutput  │  │ConsoleOutput│  │   NetworkOutput │ │ │
│  │  │  文件输出  │  │  控制台输出  │  │    网络输出     │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    装饰器层 (Decorator Layer)                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                装饰器组合                              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │ Timestamp  │  │   Color     │  │    Compression  │ │ │
│  │  │  时间戳    │  │    颜色     │  │     压缩        │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │   Filter   │  │   Format    │  │   自定义装饰器  │ │ │
│  │  │    过滤    │  │    格式     │  │                 │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    系统资源层 (System Resource Layer)        │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                系统资源抽象                              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │   File     │  │   Console   │  │      Network    │ │ │
│  │  │  文件系统  │  │  控制台     │  │     网络系统     │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心组件职责
- **LogManager**: 日志管理器，单例模式，负责协调各个组件
- **LockFreeQueue**: 无锁队列，支持多生产者多消费者模式
- **ILogOutput**: 日志输出接口，定义输出策略的抽象
- **LogDecorator**: 日志装饰器，支持功能组合和扩展
- **LogOutputFactory**: 日志输出工厂，负责对象的创建和管理

### 1.3 整体文件结构
```
AsyncLogSystem/
├── README.md                    # 项目说明文档
├── CMakeLists.txt              # 项目构建配置
├── include/                     # 头文件目录
│   ├── logTypes.hpp            # 日志类型定义
│   ├── logOutput.hpp           # 日志输出接口
│   ├── logManager.hpp          # 日志管理器主类
│   ├── logDispatcher.hpp       # 日志分发器
│   ├── logDecorator.hpp        # 装饰器基类和实现
│   ├── logFactory.hpp          # 工厂类
│   └── lockFreeQueue.hpp       # 无锁队列模板
├── src/                         # 源代码目录
│   ├── logTypes.cpp            # 类型转换实现
│   ├── logOutput.cpp           # 输出策略实现
│   ├── logManager.cpp          # 管理器实现
│   ├── logDispatcher.cpp       # 分发器实现
│   ├── logDecorator.cpp        # 装饰器实现
│   ├── logFactory.cpp          # 工厂实现
│   └── main.cpp                # 主程序入口
├── tests/                       # 测试目录
├── examples/                    # 示例目录
├── docs/                        # 文档目录
└── build/                       # 构建输出目录
```

## 2. 模块详细设计

### 2.1 日志管理器模块 (LogManager)

#### 设计目标
- 提供统一的日志接口
- 管理日志系统的生命周期
- 协调各个组件的协作
- 确保线程安全和性能

#### 核心职责
- **配置管理**: 管理日志系统的各种配置参数
- **队列管理**: 维护消息队列和线程池
- **输出管理**: 管理多个输出目标和装饰器
- **生命周期管理**: 控制系统的启动、运行和关闭

#### 设计模式
- **单例模式**: 确保全局唯一实例
- **观察者模式**: 支持配置变更通知
- **策略模式**: 支持不同的输出策略

### 2.2 队列管理模块 (LockFreeQueue)

#### 设计目标
- 高性能的消息传递
- 支持多生产者多消费者
- 无锁设计，减少线程竞争
- 内存高效使用

#### 核心特性
- **无锁算法**: 使用原子操作和内存序
- **批量操作**: 支持批量入队和出队
- **内存管理**: 智能的内存分配和回收
- **性能优化**: 缓存友好的数据结构

#### 应用场景
- 日志消息的异步传递
- 高并发环境下的消息缓冲
- 实时数据处理管道

### 2.3 日志输出模块 (ILogOutput)

#### 设计目标
- 统一的输出接口
- 支持多种输出方式
- 可扩展的输出策略
- 线程安全的实现

#### 输出策略
- **文件输出**: 支持文件轮转、大小限制、压缩
- **控制台输出**: 支持颜色、格式化、实时显示
- **网络输出**: 支持TCP/UDP、批量发送、重连机制
- **自定义输出**: 支持用户自定义输出方式

#### 设计原则
- **接口隔离**: 最小化接口依赖
- **开闭原则**: 对扩展开放，对修改关闭
- **单一职责**: 每个输出类只负责一种输出方式

### 2.4 装饰器模块 (LogDecorator)

#### 设计目标
- 动态增强日志功能
- 支持功能组合
- 保持接口一致性
- 零性能开销

#### 装饰器类型
- **时间戳装饰器**: 添加时间信息
- **颜色装饰器**: 添加颜色标识
- **压缩装饰器**: 压缩日志内容
- **过滤装饰器**: 过滤特定日志
- **格式装饰器**: 自定义输出格式

#### 组合策略
- **链式组合**: 支持多个装饰器串联
- **条件组合**: 根据配置动态组合
- **性能优化**: 避免不必要的装饰器

### 2.5 工厂模块 (LogOutputFactory)

#### 设计目标
- 统一的对象创建接口
- 支持配置驱动的创建
- 可扩展的类型注册
- 生命周期管理

#### 工厂功能
- **类型注册**: 支持自定义输出类型注册
- **配置解析**: 根据配置创建对象
- **依赖注入**: 自动注入依赖对象
- **错误处理**: 创建失败时的降级策略

## 3. 数据流设计

### 3.1 日志记录流程
```
业务线程 → 日志接口 → 消息入队 → 工作线程处理 → 装饰器链 → 分发器 → 输出目标
```

### 3.2 消息处理流程
```
1. 接收日志消息 → 2. 消息验证 → 3. 应用装饰器 → 4. 路由分发 → 5. 执行输出 → 6. 错误处理
```

### 3.3 配置更新流程
```
配置变更 → 配置验证 → 动态更新 → 组件重新配置 → 状态同步
```

## 4. 线程模型

### 4.1 线程划分策略
- **主线程**: 业务逻辑执行，日志记录
- **工作线程**: 日志消息处理，装饰器应用
- **I/O线程**: 文件/网络操作（可选）
- **监控线程**: 系统状态监控（可选）

### 4.2 线程安全策略
- **无锁队列**: 消息传递，减少锁竞争
- **读写锁**: 配置访问，支持并发读取
- **互斥锁**: 输出操作，确保原子性
- **原子操作**: 状态标志，高性能同步

### 4.3 线程池管理
- **动态调整**: 根据负载动态调整线程数
- **任务调度**: 智能的任务分配策略
- **资源控制**: 防止线程资源耗尽

## 5. 错误处理策略

### 5.1 异常处理原则
- **异常安全**: 确保系统在异常情况下的稳定性
- **错误恢复**: 自动恢复和降级机制
- **错误传播**: 合理的错误信息传递

### 5.2 错误分类和处理
- **配置错误**: 配置无效或缺失时的处理
- **I/O错误**: 文件/网络操作失败的处理
- **内存错误**: 内存分配失败的处理
- **系统错误**: 系统资源不足的处理

### 5.3 降级策略
- **功能降级**: 在错误情况下保持基本功能
- **性能降级**: 在资源不足时降低性能要求
- **输出降级**: 在输出失败时切换到备用输出
